#!/bin/bash

LOG_FILE=""
LINES=100
SHOW_ERRORS=false
SHOW_WARNINGS=false
SEARCH=""
WATCH=false
REPORT=""
STATS=false

# è§£æå‚æ•°
while [[ $# -gt 0 ]]; do
    case $1 in
        -n)
            LINES="$2"
            shift 2
            ;;
        --errors)
            SHOW_ERRORS=true
            shift
            ;;
        --warnings)
            SHOW_WARNINGS=true
            shift
            ;;
        -s|--search)
            SEARCH="$2"
            shift 2
            ;;
        --watch)
            WATCH=true
            shift
            ;;
        --report)
            REPORT="$2"
            shift 2
            ;;
        --stats)
            STATS=true
            shift
            ;;
        --)
            shift
            LOG_FILE="$1"
            break
            ;;
        *)
            LOG_FILE="$1"
            shift
            ;;
    esac
done

if [ -z "$LOG_FILE" ]; then
    echo "Usage: log-analyze <logfile> [OPTIONS]"
    echo "Options:"
    echo "  -n <num>      Show last N lines"
    echo "  --errors      Show only errors"
    echo "  --warnings    Show only warnings"
    echo "  -s <keyword>  Search for keyword"
    echo "  --watch       Real-time monitoring"
    echo "  --stats       Show statistics"
    echo "  --report <f>  Generate HTML report"
    exit 1
fi

if [ ! -f "$LOG_FILE" ]; then
    echo "âŒ File not found: $LOG_FILE"
    exit 1
fi

# è·å–æ—¥å¿—å†…å®¹
TAIL_CMD="tail -n $LINES '$LOG_FILE'"

if [ "$WATCH" = true ]; then
    echo "ğŸ“º Watching $LOG_FILE (Ctrl+C to exit)..."
    tail -f "$LOG_FILE" | while read line; do
        if [[ "$line" == *"ERROR"* ]] || [[ "$line" == *"error"* ]]; then
            echo "ğŸš¨ $line"
        elif [[ "$line" == *"WARN"* ]] || [[ "$line" == *"warning"* ]]; then
            echo "âš ï¸  $line"
        fi
    done
    exit 0
fi

# ç»Ÿè®¡æ¨¡å¼
if [ "$STATS" = true ]; then
    TOTAL_LINES=$(wc -l < "$LOG_FILE")
    ERROR_COUNT=$(grep -ci "error\|fatal\|exception" "$LOG_FILE" 2>/dev/null || echo 0)
    WARN_COUNT=$(grep -ci "warn\|warning" "$LOG_FILE" 2>/dev/null || echo 0)
    INFO_COUNT=$(grep -ci "info" "$LOG_FILE" 2>/dev/null || echo 0)
    
    echo "ğŸ“Š æ—¥å¿—ç»Ÿè®¡: $(basename $LOG_FILE)"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“‹ æ€»è¡Œæ•°: $TOTAL_LINES"
    echo "ğŸš¨ é”™è¯¯: $ERROR_COUNT"
    echo "âš ï¸  è­¦å‘Š: $WARN_COUNT"
    echo "â„¹ï¸  ä¿¡æ¯: $INFO_COUNT"
    exit 0
fi

# æœç´¢æ¨¡å¼
if [ -n "$SEARCH" ]; then
    echo "ğŸ” æœç´¢: $SEARCH"
    grep -i "$SEARCH" "$LOG_FILE" | tail -n $LINES
    exit 0
fi

# é”™è¯¯æ¨¡å¼
if [ "$SHOW_ERRORS" = true ]; then
    grep -i "error\|fatal\|exception" "$LOG_FILE" | tail -n $LINES
    exit 0
fi

# è­¦å‘Šæ¨¡å¼
if [ "$SHOW_WARNINGS" = true ]; then
    grep -i "warn\|warning" "$LOG_FILE" | tail -n $LINES
    exit 0
fi

# é»˜è®¤æ˜¾ç¤ºæœ€å N è¡Œ
tail -n $LINES "$LOG_FILE"
